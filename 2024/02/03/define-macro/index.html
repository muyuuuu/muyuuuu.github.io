<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/apple-touch-icon-next.png">
  <link rel="mask-icon" href="/images/apple-touch-icon-next.png" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"muyuuuu.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"default"},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":true,"pangu":false,"comments":{"style":"tabs","active":"gitalk","storage":true,"lazyload":false,"nav":null,"activeClass":"gitalk"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":10,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="之前对 C 语言中宏定义的认知十分简单，包括但不限于停留在以下浅薄的层面： 12#define PI 3.14#define add(a, b) a + b 上述代码完全是大学课本中的用法。但当我看到实际项目中宏的用法后完全是一头雾水，所以自己也要写出那种高逼格让别人看不太懂的代码。宏远远比我想象的要强大，所以本文为每个宏技巧都配备了一个实用场景。  字符串化操作符，实现一个简单的自动化测试样例">
<meta property="og:type" content="article">
<meta property="og:title" content="C 语言中的黑魔法：宏">
<meta property="og:url" content="https://muyuuuu.github.io/2024/02/03/define-macro/index.html">
<meta property="og:site_name" content="Just for Life.">
<meta property="og:description" content="之前对 C 语言中宏定义的认知十分简单，包括但不限于停留在以下浅薄的层面： 12#define PI 3.14#define add(a, b) a + b 上述代码完全是大学课本中的用法。但当我看到实际项目中宏的用法后完全是一头雾水，所以自己也要写出那种高逼格让别人看不太懂的代码。宏远远比我想象的要强大，所以本文为每个宏技巧都配备了一个实用场景。  字符串化操作符，实现一个简单的自动化测试样例">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2024-02-02T17:36:01.000Z">
<meta property="article:modified_time" content="2024-12-13T15:47:49.093Z">
<meta property="article:author" content="兰铃">
<meta property="article:tag" content="C">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://muyuuuu.github.io/2024/02/03/define-macro/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>C 语言中的黑魔法：宏 | Just for Life.</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Just for Life." type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Just for Life.</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">明月更几时</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>本站主页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>时光轴</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于兰铃</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签云</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-image fa-fw"></i>远夏拾忆</a>

  </li>
        <li class="menu-item menu-item-share">

    <a href="/share/" rel="section"><i class="fa fa-share fa-fw"></i>好物分享</a>

  </li>
        <li class="menu-item menu-item-message">

    <a href="/message/" rel="section"><i class="fa fa-list fa-fw"></i>留言板</a>

  </li>
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fa fa-link fa-fw"></i>友情链接</a>

  </li>
        <li class="menu-item menu-item-reward">

    <a href="/reward/" rel="section"><i class="fa fa-history fa-fw"></i>博客收益</a>

  </li>
        <li class="menu-item menu-item-hot">

    <a href="/hot/" rel="section"><i class="fa fa-fire fa-fw"></i>热门文章</a>

  </li>
        <li class="menu-item menu-item-record">

    <a href="/record/" rel="section"><i class="fa fa-sticky-note fa-fw"></i>记录</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>本地搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://muyuuuu.github.io/2024/02/03/define-macro/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="兰铃">
      <meta itemprop="description" content="爱生活-------爱读书-------爱摄影   爱运动-------爱睡觉-------爱旅行">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Just for Life.">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          C 语言中的黑魔法：宏
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-02-03 01:36:01" itemprop="dateCreated datePublished" datetime="2024-02-03T01:36:01+08:00">2024-02-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-12-13 23:47:49" itemprop="dateModified" datetime="2024-12-13T23:47:49+08:00">2024-12-13</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>9.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>8 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前对 <code>C</code> 语言中宏定义的认知十分简单，包括但不限于停留在以下浅薄的层面：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PI 3.14</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> add(a, b) a + b</span></span><br></pre></td></tr></table></figure>
<p>上述代码完全是大学课本中的用法。但当我看到实际项目中宏的用法后完全是一头雾水，<del>所以自己也要写出那种高逼格让别人看不太懂的代码</del>。宏远远比我想象的要强大，所以本文为每个宏技巧都配备了一个实用场景。</p>
<ul>
<li>字符串化操作符，实现一个简单的自动化测试样例</li>
<li>字符串连接，实现一个具备计时功能的宏</li>
<li>X 宏，实现根据输入执行不同的函数</li>
<li>特殊宏 <code>__VA_ARGS__</code>，实现一个简单的日志函数</li>
</ul>
<span id="more"></span>
<h1 id="字符串化操作符"><a href="#字符串化操作符" class="headerlink" title="字符串化操作符"></a>字符串化操作符</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> str(a) #a</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">str</span>(FUNC);   <span class="comment">// 输出 FUNC</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述宏 <code>str</code> 通过单井号的形式实现了字符串化操作符，将传入的参数字符串化。</p>
<h2 id="简单测试框架"><a href="#简单测试框架" class="headerlink" title="简单测试框架"></a>简单测试框架</h2><p>C 语言有一些预定义的宏，比如 <code>__LINE__</code> 表示当前行号，<code>__FILE__</code> 表示当前的文件名。基于这一基础，我们实现一个简单的测试程序。在测试程序时，打印测试用例、文件名、行号、以及是否通过测试。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG_INFO(format) printf(format)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __TO_STR__(x) #x <span class="string">&quot;:&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __TO_REAL__(x) __TO_STR__(x)</span></span><br><span class="line"><span class="comment">// 文件:行号</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __FILE_LINE__ __FILE__ <span class="string">&quot;:&quot;</span> __TO_REAL__(__LINE__)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CHECK_VAL(val) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        LOG_INFO(__FILE_LINE__ <span class="string">&quot;:calling &quot;</span> #val <span class="string">&quot;\n&quot;</span>); \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (0 == (val)) &#123; \</span></span><br><span class="line"><span class="meta">            LOG_INFO(__FILE_LINE__ <span class="string">&quot;:error \n&quot;</span>); \</span></span><br><span class="line"><span class="meta">            goto fail; \</span></span><br><span class="line"><span class="meta">        &#125; <span class="keyword">else</span> &#123; \</span></span><br><span class="line"><span class="meta">            LOG_INFO(__FILE_LINE__ <span class="string">&quot;:passed \n&quot;</span>); \</span></span><br><span class="line"><span class="meta">        &#125; \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">test_func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n_total = <span class="number">2</span>;</span><br><span class="line">    <span class="type">int</span> n_passed = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CHECK_VAL</span>(<span class="number">1</span> == <span class="built_in">test_func</span>());</span><br><span class="line">    n_passed ++;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">CHECK_VAL</span>(<span class="number">2</span> == <span class="built_in">test_func</span>());</span><br><span class="line">    n_passed ++;</span><br><span class="line"></span><br><span class="line">fail:</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;################ summary ###################\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;passed: %d\n&quot;</span>, n_passed);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;total: %d\n&quot;</span>, n_total);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>#val</code> 会打印测试样例</li>
<li><code>__FILE_LINE__</code> 会打印当前的文件名和行号</li>
</ul>
<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">demo.cpp:30::calling 1 == test_func()</span><br><span class="line">demo.cpp:30::passed </span><br><span class="line">demo.cpp:33::calling 2 == test_func()</span><br><span class="line">demo.cpp:33::error </span><br><span class="line">################ summary ###################</span><br><span class="line">passed: 1</span><br><span class="line">total: 2</span><br></pre></td></tr></table></figure>
<h2 id="为什么用-do-while-0-？"><a href="#为什么用-do-while-0-？" class="headerlink" title="为什么用 do-while(0) ？"></a>为什么用 do-while(0) ？</h2><p>当时我看到这一用法也比较疑惑，但 <code>do-while(0)</code> 的用法还是比较常见的。多用于在一个宏定义中出现多条语句的场景中，那我们来分析一下为什么要这么用。如果我们这样定义：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SS \</span></span><br><span class="line"><span class="meta">    stmt1; \</span></span><br><span class="line"><span class="meta">    stmt2;</span></span><br></pre></td></tr></table></figure>
<p>在以下的使用场景中：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond)</span><br><span class="line">    SS;</span><br><span class="line">    stmt3;</span><br></pre></td></tr></table></figure>
<p>宏展开后，会变成：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond)</span><br><span class="line">    stmt1;</span><br><span class="line">    stmt2;</span><br><span class="line">    ;</span><br><span class="line">    stmt3;</span><br></pre></td></tr></table></figure>
<p>所以不管 <code>cond</code> 是真是假，<code>stmt2</code> 语句都会执行。而我们自己的意图肯定是，只有 <code>cond</code> 为真的时候，<code>stmt1</code> 和 <code>stmt2</code> 才会执行。那我们给宏加上花括号试一试：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SS &#123; \</span></span><br><span class="line"><span class="meta">    stmt1; \</span></span><br><span class="line"><span class="meta">    stmt2; \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p>但是在下面这种情况下，还是会存在一些错误：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond)</span><br><span class="line">    SS;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    stmt3;</span><br></pre></td></tr></table></figure>
<p>这样宏展开的结果为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cond) &#123; </span><br><span class="line">    stmt1; </span><br><span class="line">    stmt2; </span><br><span class="line">&#125;</span><br><span class="line">;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    stmt3;</span><br></pre></td></tr></table></figure>
<p>直接导致编译错误，而出错的原因是 <code>else</code> 前面多一个分号。当然也可以在使用 <code>SS</code> 的地方后面不加分号，但是在 C 语言中通常我们习惯性的会在语句后面加一个分号。鉴于上面的这些原因，就有人想出了 <code>do-while(0)</code> 式的用法：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> SS \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        stmt1; \</span></span><br><span class="line"><span class="meta">        stmt2; \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br></pre></td></tr></table></figure>
<h1 id="字符串连接"><a href="#字符串连接" class="headerlink" title="字符串连接"></a>字符串连接</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> define_val(tag)  \</span></span><br><span class="line"><span class="meta">    int a_##tag = 77</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">define_val</span>(MAX);</span><br><span class="line">    std::cout &lt;&lt; a_MAX;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面代码的意思是，将 <code>a_</code> 和传入的 <code>tag</code> 连接在一起，意思是：<code>int a_MAX = 77;</code> 的意思。上述代码中完全没有直接出现 <code>a_MAX</code> 这个字符串，但我们依然可以使用。</p>
<p>这样做的一点点好处是：比如现在有 100 个模块分散在项目的各个角落，需要给各个模块计时统计性能。那么每次都定义起始时间、结束时间，并且计算执行时间，这些操作都是重复的。为了精简重复的操作，我们可以使用这个宏技巧来实现。如下所示的代码，我们把宏放到头文件，用户在引用头文件后，只需要两行代码就可以快速完成对模块的计时功能。</p>
<h2 id="测试函数执行时间的宏"><a href="#测试函数执行时间的宏" class="headerlink" title="测试函数执行时间的宏"></a>测试函数执行时间的宏</h2><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">Time</span> &#123;</span><br><span class="line">    <span class="type">double</span> time;</span><br><span class="line">&#125; Time;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">GetTime</span><span class="params">(Time* T)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">timeval</span> tv;</span><br><span class="line">    <span class="built_in">gettimeofday</span>(&amp;tv, <span class="literal">NULL</span>);</span><br><span class="line">    T-&gt;time = (tv.tv_sec * <span class="number">1000.0</span>) + (tv.tv_usec / <span class="number">1000.0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIME_START(tag) \</span></span><br><span class="line"><span class="meta">    Time tag##_start, tag##_end; \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        GetTime(&amp;(tag##_start)); \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TIME_END(tag) \</span></span><br><span class="line"><span class="meta">    do &#123; \</span></span><br><span class="line"><span class="meta">        GetTime(&amp;(tag##_end)); \</span></span><br><span class="line"><span class="meta">        printf(#tag <span class="string">&quot; cost %.2f \n&quot;</span>, tag##_end.time - tag##_start.time); \</span></span><br><span class="line"><span class="meta">    &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">usleep</span>(<span class="number">10000</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录开始时间</span></span><br><span class="line">    <span class="built_in">TIME_START</span>(loop_func_20);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">20</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">func</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 记录结束时间</span></span><br><span class="line">    <span class="built_in">TIME_END</span>(loop_func_20);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">loop_func_20 cost 202.44ms </span><br></pre></td></tr></table></figure>
<h1 id="实现泛型"><a href="#实现泛型" class="headerlink" title="实现泛型"></a>实现泛型</h1><p>由于转专业，需要在大二补学大一的课程。在学 <code>C#</code> 的时候，舍友对泛型总结为五个字：「参数化类型」惊艳了连 <code>C</code> 都写不利索的我。就像 <code>C++</code> 的模板一样，为一个函数只写一套代码，把类型看成参数，但是这个函数能支持各个类型。如果 <code>C</code> 要实现泛型，宏定义是必不可少的方案。</p>
<p>加入此时我们面临一个需求，有一个 <code>matirx</code>，如果数据类型是 <code>u8</code>，那么调用 <code>WriteU8ToFile</code> 函数将数据写到文件；如果数据类型是 <code>u16</code>，那么调用 <code>WriteU16ToFile</code> 函数将数据写出到文件。</p>
<p>我们大概写一下这俩函数的伪代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="type">void</span> *data;</span><br><span class="line">&#125; Matrix;</span><br><span class="line"></span><br><span class="line">WriteU8ToFile(Matrix *mat, <span class="type">const</span> <span class="type">char</span> *file) &#123;</span><br><span class="line">    Fopen(file);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint8_t</span> *data = (<span class="type">uint8_t</span> *)(mat-&gt;data);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mat-&gt;size; i++) &#123;</span><br><span class="line">        FWrite(<span class="string">&quot;%d&quot;</span>, (<span class="type">int</span>)data[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Fclose(file)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">WriteU16ToFile(Matrix *mat, <span class="type">const</span> <span class="type">char</span> *file) &#123;</span><br><span class="line">    Fopen(file);</span><br><span class="line"></span><br><span class="line">    <span class="type">uint16_t</span> *data = (<span class="type">uint16_t</span> *)(mat-&gt;data);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; mat-&gt;size; i++) &#123;</span><br><span class="line">        FWrite(<span class="string">&quot;%d&quot;</span>, (<span class="type">int</span>)data[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Fclose(file)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到，除了函数名中的 <code>U8</code> 和 <code>U16</code>，以及函数体中的 <code>uint8_t</code> 和 <code>uint16_t</code>，其余内容完全一样。能不能像 <code>C++</code> 的模板一样，写一套通用的代码，而不是将代码重复这么多次导致冗余？</p>
<p>我们可以用宏定义代替 <code>U8</code> 和 <code>uint8_t</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_DATA_TO_TXT(type, typeName)                                   \</span></span><br><span class="line"><span class="meta">void Write##typeName##DataToTxt(Matrix *src, const char *path) &#123;            \</span></span><br><span class="line"><span class="meta">    FILE *file_ptr = fopen(path, <span class="string">&quot;w&quot;</span>);                                      \</span></span><br><span class="line"><span class="meta">    for (int i = 0; i <span class="string">&lt; src-&gt;</span>h; i++) &#123;                                      \</span></span><br><span class="line"><span class="meta">        type *data = (type *)src-&gt;data + i * src-&gt;pitch / sizeof(type);     \</span></span><br><span class="line"><span class="meta">        for (int j = 0; j <span class="string">&lt; src-&gt;</span>w; j++) &#123;                                  \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (#typeName == <span class="string">&quot;U8&quot;</span>) &#123;                                        \</span></span><br><span class="line"><span class="meta">                fprintf(file_ptr, <span class="string">&quot;U8  %d\n&quot;</span>, (int)data[j]);                \</span></span><br><span class="line"><span class="meta">            &#125; <span class="keyword">else</span> &#123;                                                        \</span></span><br><span class="line"><span class="meta">                fprintf(file_ptr, <span class="string">&quot;U16 %d\n&quot;</span>, (int)data[j]);                \</span></span><br><span class="line"><span class="meta">            &#125;                                                               \</span></span><br><span class="line"><span class="meta">        &#125;                                                                   \</span></span><br><span class="line"><span class="meta">    &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    fclose(file_ptr);                                                       \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样，调用这个宏定义的函数时，可以通过设置 <code>type</code> 和 <code>typeName</code> 字段去生成各个类型的函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WRITE_DATA_TO_TXT(<span class="type">uint8_t</span>, U8)      <span class="comment">// 生成 uint8_t 的函数 WriteU8DataToTxt</span></span><br><span class="line"></span><br><span class="line">WRITE_DATA_TO_TXT(<span class="type">uint16_t</span>, U16)    <span class="comment">// 生成 uint16_t 的函数 WriteU16DataToTxt</span></span><br></pre></td></tr></table></figure>
<p>完整代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> w;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="type">int</span> pitch;</span><br><span class="line">    <span class="type">void</span> *data;</span><br><span class="line">&#125; Matrix;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WRITE_DATA_TO_TXT(type, typeName)                                   \</span></span><br><span class="line"><span class="meta">void Write##typeName##DataToTxt(Matrix *src, const char *path) &#123;            \</span></span><br><span class="line"><span class="meta">    FILE *file_ptr = fopen(path, <span class="string">&quot;w&quot;</span>);                                      \</span></span><br><span class="line"><span class="meta">    for (int i = 0; i <span class="string">&lt; src-&gt;</span>h; i++) &#123;                                      \</span></span><br><span class="line"><span class="meta">        type *data = (type *)src-&gt;data + i * src-&gt;pitch / sizeof(type);     \</span></span><br><span class="line"><span class="meta">        for (int j = 0; j <span class="string">&lt; src-&gt;</span>w; j++) &#123;                                  \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (#typeName == <span class="string">&quot;U8&quot;</span>) &#123;                                        \</span></span><br><span class="line"><span class="meta">                fprintf(file_ptr, <span class="string">&quot;U8  %d\n&quot;</span>, (int)data[j]);                \</span></span><br><span class="line"><span class="meta">            &#125; <span class="keyword">else</span> &#123;                                                        \</span></span><br><span class="line"><span class="meta">                fprintf(file_ptr, <span class="string">&quot;U16 %d\n&quot;</span>, (int)data[j]);                \</span></span><br><span class="line"><span class="meta">            &#125;                                                               \</span></span><br><span class="line"><span class="meta">        &#125;                                                                   \</span></span><br><span class="line"><span class="meta">    &#125;                                                                       \</span></span><br><span class="line"><span class="meta">    fclose(file_ptr);                                                       \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br><span class="line"></span><br><span class="line">WRITE_DATA_TO_TXT(<span class="type">uint8_t</span>, U8)</span><br><span class="line"></span><br><span class="line">WRITE_DATA_TO_TXT(<span class="type">uint16_t</span>, U16)</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> &#123;</span><br><span class="line">    Matrix u8Mat = &#123;.w = <span class="number">3</span>, .h = <span class="number">2</span>, .pitch = <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>), .data = <span class="built_in">malloc</span>(<span class="number">3</span> * <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">uint8_t</span>))&#125;;</span><br><span class="line">    <span class="type">uint8_t</span> *u8Data = (<span class="type">uint8_t</span> *)u8Mat.data;</span><br><span class="line">    u8Data[<span class="number">0</span>] = <span class="number">1</span>; u8Data[<span class="number">1</span>] = <span class="number">2</span>; u8Data[<span class="number">2</span>] = <span class="number">3</span>;</span><br><span class="line">    u8Data[<span class="number">3</span>] = <span class="number">4</span>; u8Data[<span class="number">4</span>] = <span class="number">5</span>; u8Data[<span class="number">5</span>] = <span class="number">6</span>;</span><br><span class="line">    WriteU8DataToTxt(&amp;u8Mat, <span class="string">&quot;u8_data.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    Matrix u16Mat = &#123;.w = <span class="number">3</span>, .h = <span class="number">2</span>, .pitch = <span class="number">3</span> * <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>), .data = <span class="built_in">malloc</span>(<span class="number">3</span> * <span class="number">2</span> * <span class="keyword">sizeof</span>(<span class="type">uint16_t</span>))&#125;;</span><br><span class="line">    <span class="type">uint16_t</span> *u16Data = (<span class="type">uint16_t</span> *)u16Mat.data;</span><br><span class="line">    u16Data[<span class="number">0</span>] = <span class="number">10</span>; u16Data[<span class="number">1</span>] = <span class="number">20</span>; u16Data[<span class="number">2</span>] = <span class="number">30</span>;</span><br><span class="line">    u16Data[<span class="number">3</span>] = <span class="number">40</span>; u16Data[<span class="number">4</span>] = <span class="number">50</span>; u16Data[<span class="number">5</span>] = <span class="number">60</span>;</span><br><span class="line">    WriteU16DataToTxt(&amp;u16Mat, <span class="string">&quot;u16_data.txt&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(u8Mat.data);</span><br><span class="line">    <span class="built_in">free</span>(u16Mat.data);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="特殊宏"><a href="#特殊宏" class="headerlink" title="特殊宏"></a>特殊宏</h1><p><code>__VA_ARGS__</code> 是一个预处理器宏，用于表示可变参数列表。它通常用于定义可变参数的宏，例如 <code>printf</code> 函数。在宏定义中，<code>__VA_ARGS__</code> 表示可变参数列表部分，可以在宏展开时将其替换为实际的参数列表。官方定义较为玄幻，直接看代码吧：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG(format, ...) printf(format, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;===== info =====\n&quot;</span>);   <span class="comment">// 0 参数</span></span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;data is %d\n&quot;</span>, <span class="number">2</span>);      <span class="comment">// 1 个参数</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="一个简单的打日志函数"><a href="#一个简单的打日志函数" class="headerlink" title="一个简单的打日志函数"></a>一个简单的打日志函数</h2><p>给上述代码加一些辅助信息，就可以实现一个日志函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> LOG(tag, format, ...) \</span></span><br><span class="line"><span class="meta">    printf(<span class="string">&quot;[%s] [%s %s %d] &quot;</span> format, tag, __FILE__, __FUNCTION__, __LINE__, ##__VA_ARGS__)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;BASE&quot;</span>, <span class="string">&quot;Nothing\n&quot;</span>);</span><br><span class="line">    <span class="built_in">LOG</span>(<span class="string">&quot;BASE&quot;</span>, <span class="string">&quot; ? info diff &gt;= %d : %.4f %d\n&quot;</span>, <span class="number">2</span>, <span class="number">0.1</span>, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对于</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">LOG</span>(<span class="string">&quot;BASE&quot;</span>, <span class="string">&quot;Nothing&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>宏展开为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;[%s] [%s %s %d] &quot;</span> <span class="string">&quot;Nothing&quot;</span>, <span class="string">&quot;Base&quot;</span>, <span class="string">&quot;demo.cpp&quot;</span>, <span class="string">&quot;main&quot;</span>, <span class="number">7</span>);  </span><br></pre></td></tr></table></figure>
<p>注意，<code>Nothing</code> 这个信息是在 <code>format</code> 中，因此第一个 <code>%s</code> 对应的是 <code>tag</code>，所以最终输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[BASE] [test.cpp main 8] Nothing</span><br></pre></td></tr></table></figure>
<p>同理，第二个宏展开后的输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[BASE] [test.cpp main 7]  ? info diff &gt;= 2 : 0.1000 2</span><br></pre></td></tr></table></figure>
<ul>
<li>注意：代码中使用 <code>##__VA_ARGS__</code> 而不是 <code>__VA_ARGS__</code>，这是因为 <code>##__VA_ARGS__</code> 用于在可变参数列表为空时删除前面的逗号。在 C 语言中，如果可变参数列表为空，则在逗号之后没有参数，这会导致编译错误。</li>
</ul>
<h1 id="X-宏的使用"><a href="#X-宏的使用" class="headerlink" title="X 宏的使用"></a>X 宏的使用</h1><p>通过宏定义的方式，根据指令执行不同的函数。比如输入的指令是 <code>CMD_LED_ON</code>，执行的函数是 <code>led_on</code>；输入的指令是 <code>CMD_LED_OFF</code>，执行的函数是 <code>led_off</code>。首先定义这两个函数：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">led_on</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s \r\n&quot;</span>, (<span class="type">char</span> *)p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">led_off</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s \r\n&quot;</span>, (<span class="type">char</span> *)p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将这两个指令 <code>CMD_LED_ON</code> 和 <code>CMD_LED_OFF</code> 定义到一个枚举变量中，不过是以宏的形式：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MACROS_TABLE                    \</span></span><br><span class="line"><span class="meta">    X_MACROS(CMD_LED_ON,  led_on)       \</span></span><br><span class="line"><span class="meta">    X_MACROS(CMD_LED_OFF, led_off)      \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment">/*定义命令列表*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> X_MACROS(a, b) a,</span></span><br><span class="line">    MACROS_TABLE</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> X_MACROS</span></span><br><span class="line">    CMD_MAX</span><br><span class="line">&#125; cmd_e;</span><br></pre></td></tr></table></figure>
<p><code>#define X_MACROS(a, b) a</code> 表示取出 <code>(a, b)</code> 中的第一个元素 <code>a</code>，则宏展开后的代码为：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> X_MACROS(a, b) a,</span></span><br><span class="line">    <span class="built_in">X_MACROS</span>(CMD_LED_ON,  led_on)       \</span><br><span class="line">    <span class="built_in">X_MACROS</span>(CMD_LED_OFF, led_off)      \</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> X_MACROS</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">继续把 X_MACROS 展开得到：</span><br><span class="line"></span><br><span class="line"><span class="comment">/*定义命令列表*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    CMD_LED_ON,</span><br><span class="line">    CMD_LED_OFF,</span><br><span class="line">    CMD_MAX</span><br><span class="line">&#125; cmd_e;</span><br></pre></td></tr></table></figure>
<p><code>#define X_MACROS(a, b) b,</code> 表示取出宏的第二个元素。使用同样的方法，在定义一个函数数组：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*func)</span><span class="params">(<span class="type">void</span>* p)</span></span>;</span><br><span class="line"><span class="type">const</span> func func_table[] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> X_MACROS(a, b) b,</span></span><br><span class="line">    MACROS_TABLE</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> X_MACROS</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">宏展开为：</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> func func_table[] =</span><br><span class="line">&#123;</span><br><span class="line">    led_on,</span><br><span class="line">    led_off</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>此时，<code>func_table[CMD_LED_ON]</code> 指向了 <code>led_on</code> 函数，<code>func_table[CMD_LED_OFF]</code> 指向了 <code>led_off</code> 函数，就实现了简单的根据不同的输入指令执行不同的函数。完成代码如下：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MACROS_TABLE                    \</span></span><br><span class="line"><span class="meta">    X_MACROS(CMD_LED_ON,  led_on)       \</span></span><br><span class="line"><span class="meta">    X_MACROS(CMD_LED_OFF, led_off)      \</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment">/*定义命令列表*/</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> X_MACROS(a, b) a,</span></span><br><span class="line">    MACROS_TABLE</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> X_MACROS</span></span><br><span class="line">    CMD_MAX</span><br><span class="line">&#125; cmd_e;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*定义字符串列表用作Log打印*/</span></span><br><span class="line"><span class="type">const</span> <span class="type">char</span>* cmd_str[] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> X_MACROS(a, b) #a,</span></span><br><span class="line">    MACROS_TABLE</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> X_MACROS</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">void</span> <span class="params">(*func)</span><span class="params">(<span class="type">void</span>* p)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">led_on</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s \r\n&quot;</span>, (<span class="type">char</span> *)p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">led_off</span><span class="params">(<span class="type">void</span>* p)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s \r\n&quot;</span>, (<span class="type">char</span> *)p);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">const</span> func func_table[] =</span><br><span class="line">&#123;</span><br><span class="line">    <span class="meta">#<span class="keyword">define</span> X_MACROS(a, b) b,</span></span><br><span class="line">    MACROS_TABLE</span><br><span class="line">    <span class="meta">#<span class="keyword">undef</span> X_MACROS</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> <span class="type">void</span> <span class="title">cmd_handle</span><span class="params">(cmd_e cmd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(cmd &lt; CMD_MAX)</span><br><span class="line">    &#123;</span><br><span class="line">        func_table[cmd]((<span class="type">void</span>*)cmd_str[cmd]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">cmd_handle</span>(CMD_LED_ON);</span><br><span class="line">    <span class="built_in">cmd_handle</span>(CMD_LED_OFF);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><ol>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/521073931">X-宏的用法</a></li>
</ol>

    </div>

    
    
    
      

        <div class="reward-container">
  <div>感谢上学期间打赏我的朋友们。赛博乞讨：我，秦始皇，打钱。</div>
  <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
      
      <div style="display: inline-block;">
        <img src="/images/wechatpay.jpg" alt="兰铃 o(*≧▽≦)ツ">
        <p>o(*≧▽≦)ツ</p>
      </div>
      
      <div style="display: inline-block;">
        <img src="/images/alipay.jpg" alt="兰铃 ♪(^∇^*)">
        <p>♪(^∇^*)</p>
      </div>

  </div>
</div>

        

  <div class="followme">
    <p>欢迎订阅我的文章</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/atom.xml">
            <span class="icon">
              <i class="rss"></i>
            </span>

            <span class="label">RSS</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C</a>
          </div>

        
  <div class="post-widgets">
    <div class="wp_rating">
      <div id="wpac-rating"></div>
    </div>
  </div>


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/02/03/an-unpleasant-experience-dev/" rel="prev" title="一次不太愉快的软件开发">
      <i class="fa fa-chevron-left"></i> 一次不太愉快的软件开发
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/03/03/mobile-algorithm-optimize/" rel="next" title="移动端算法优化">
      移动端算法优化 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%8C%96%E6%93%8D%E4%BD%9C%E7%AC%A6"><span class="nav-number">1.</span> <span class="nav-text">字符串化操作符</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E6%B5%8B%E8%AF%95%E6%A1%86%E6%9E%B6"><span class="nav-number">1.1.</span> <span class="nav-text">简单测试框架</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88%E7%94%A8-do-while-0-%EF%BC%9F"><span class="nav-number">1.2.</span> <span class="nav-text">为什么用 do-while(0) ？</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E8%BF%9E%E6%8E%A5"><span class="nav-number">2.</span> <span class="nav-text">字符串连接</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%87%BD%E6%95%B0%E6%89%A7%E8%A1%8C%E6%97%B6%E9%97%B4%E7%9A%84%E5%AE%8F"><span class="nav-number">2.1.</span> <span class="nav-text">测试函数执行时间的宏</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%B3%9B%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">实现泛型</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%89%B9%E6%AE%8A%E5%AE%8F"><span class="nav-number">4.</span> <span class="nav-text">特殊宏</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%89%93%E6%97%A5%E5%BF%97%E5%87%BD%E6%95%B0"><span class="nav-number">4.1.</span> <span class="nav-text">一个简单的打日志函数</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#X-%E5%AE%8F%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-number">5.</span> <span class="nav-text">X 宏的使用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%8F%82%E8%80%83"><span class="nav-number">6.</span> <span class="nav-text">参考</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="兰铃"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">兰铃</p>
  <div class="site-description" itemprop="description">爱生活-------爱读书-------爱摄影   爱运动-------爱睡觉-------爱旅行</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">228</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">相册</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/muyuuuu" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;muyuuuu" rel="noopener" target="_blank"><i class="github fa-fw"></i>GitHub</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">兰铃</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">1m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">15:12</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div><div id="days"></div>
<script>
function show_date_time(){
    window.setTimeout("show_date_time()", 1000);
    BirthDay=new Date("09/28/2018 23:13:14");//修改为自己的blog建站时间
    today=new Date();
    timeold=(today.getTime()-BirthDay.getTime());
    sectimeold=timeold/1000
    secondsold=Math.floor(sectimeold);
    msPerDay=24*60*60*1000
    e_daysold=timeold/msPerDay
    daysold=Math.floor(e_daysold);
    e_hrsold=(e_daysold-daysold)*24;
    hrsold=setzero(Math.floor(e_hrsold));
    e_minsold=(e_hrsold-hrsold)*60;
    minsold=setzero(Math.floor((e_hrsold-hrsold)*60));
    seconds=setzero(Math.floor((e_minsold-minsold)*60));
    document.getElementById('days').innerHTML="已在此等候你"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}
function setzero(i){
    if (i<10)
    {i="0" + i};
    return i;
}
show_date_time();
</script>



        
<div class="busuanzi-count">
  <script data-pjax async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
      <span class="site-uv" title="总访客量">
        我的第 <span id="busuanzi_value_site_uv"></span> 位朋友
      </span>
    <span class="post-meta-divider">|</span>
      <span class="site-pv" title="总访问量">
        经过 <span id="busuanzi_value_site_pv"></span> 次回眸与你相遇
      </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-pjax@0/pjax.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/lozad@1/dist/lozad.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

  <script>
var pjax = new Pjax({
  selectors: [
    'head title',
    '#page-configurations',
    '.content-wrap',
    '.post-toc-wrap',
    '.languages',
    '#pjax'
  ],
  switches: {
    '.post-toc-wrap': Pjax.switches.innerHTML
  },
  analytics: false,
  cacheBust: false,
  scrollTo : !CONFIG.bookmark.enable
});

window.addEventListener('pjax:success', () => {
  document.querySelectorAll('script[data-pjax], script#page-configurations, #pjax script').forEach(element => {
    var code = element.text || element.textContent || element.innerHTML || '';
    var parent = element.parentNode;
    parent.removeChild(element);
    var script = document.createElement('script');
    if (element.id) {
      script.id = element.id;
    }
    if (element.className) {
      script.className = element.className;
    }
    if (element.type) {
      script.type = element.type;
    }
    if (element.src) {
      script.src = element.src;
      // Force synchronous loading of peripheral JS.
      script.async = false;
    }
    if (element.dataset.pjax !== undefined) {
      script.dataset.pjax = '';
    }
    if (code !== '') {
      script.appendChild(document.createTextNode(code));
    }
    parent.appendChild(script);
  });
  NexT.boot.refresh();
  // Define Motion Sequence & Bootstrap Motion.
  if (CONFIG.motion.enable) {
    NexT.motion.integrator
      .init()
      .add(NexT.motion.middleWares.subMenu)
      .add(NexT.motion.middleWares.postList)
      .bootstrap();
  }
  NexT.utils.updateSidebarPosition();
});
</script>




  
  <script data-pjax>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>



  <script data-pjax>
  if (CONFIG.page.isPost) {
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id    : 24077,
      el    : 'wpac-rating',
      color : 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  }
  </script>

  
<script src="/js/local-search.js"></script>









<script data-pjax>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>




    <div id="pjax">
  

  

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '639ddab88527bca5fe75',
      clientSecret: '0c08625a06e8796096a190cad5c07b4909d1e960',
      repo        : 'blabla',
      owner       : 'muyuuuu',
      admin       : ['muyuuuu'],
      id          : '6138269cb3909a5a21a366faf1692b24',
        language: 'zh-CN',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

    </div>
</body>
</html>
